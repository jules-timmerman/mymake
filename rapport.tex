\documentclass[11pt]{report}
\usepackage[utf8]{inputenc}
\usepackage[french]{babel}
\usepackage[T1]{fontenc}
\usepackage{mathrsfs}

\usepackage[a4paper,width=160mm,top=35mm,bottom=35mm]{geometry}

\usepackage{booktabs}
\usepackage{array}
\usepackage{subfig}
\usepackage{amsmath,amsfonts,amssymb}

\usepackage{mathtools}
\usepackage{titlesec} 
\usepackage{enumitem}
\usepackage{listings}
\usepackage{mathdots}
\usepackage{comment}


% Codes source
\usepackage{listings}
\usepackage{xcolor}

\definecolor{codegreen}{rgb}{0,0.6,0.1}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{blue},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}

\lstset{literate=
{é}{{\'e}}{1}
{è}{{\`e}}{1}
{à}{{\`a}}{1}
{ç}{{\c{c}}}{1}
{œ}{{\oe}}{1}
{ù}{{\`u}}{1}
{É}{{\'E}}{1}
{È}{{\`E}}{1}
{À}{{\`A}}{1}
{Ç}{{\c{C}}}{1}
{Œ}{{\OE}}{1}
{Ê}{{\^E}}{1}
{ê}{{\^e}}{1}
{î}{{\^i}}{1}
{ô}{{\^o}}{1}
{û}{{\^u}}{1}
{ë}{{\¨{e}}}1
{û}{{\^{u}}}1
{â}{{\^{a}}}1
{Â}{{\^{A}}}1
{Î}{{\^{I}}}1
} 

\lstset{style=mystyle}

% Encadrés
\usepackage{tcolorbox}

% Graphes
\usepackage{tikz}
\usepackage{tikz-cd}


%\renewcommand{\thesection}{\arabic{section}}
%\renewcommand{\thesubsection}{\arabic{subsection}}


\usepackage{parskip}
\usepackage{tgpagella}


\newcounter{question}[section]
\newenvironment{question}[1][]{\refstepcounter{question}\par\medskip
   \noindent\textbf{Question~\thequestion ~ $-$} \rmfamily}{}


\newtcolorbox[auto counter,number within=section]{code}[2][]{
fonttitle=\bfseries,
title=Code source de #2,#1,
colback=white,
colframe=black,
arc=0mm
}





\title{MyMake}
\date{Octobre 2022}
\author{Guilhem Repetto \and Jules Timmerman}


\begin{document}

\maketitle

\begin{abstract}

\end{abstract}



\begin{question} %% Question 1
Pour créer le fichier \textbf{Makefile}, il faut comprendre la dépendance entre les fichiers du projet.
Nous voulons compiler un fichier exécutable \textbf{main} à partir du fichier \textbf{main.c}.

Tout d'abord, rappelons qu'au minimum, le fichier \textbf{main.c} est transformé par le préprocesseur en un fichier \textbf{main.i}, compilé en un fichier assembleur \textbf{main.s}, puis en un fichier binaire \textbf{main.o}. Enfin, l'étape d'édition des liens utilise \textbf{main.o} ainsi que tous les fichiers binaires (en \textbf{.o}) des bibliothèques et des fichiers annexes déclarés dans le \textit{header} de \textbf{main.c} (fichiers en \textbf{.h}) utilisés pour produire un fichier final exécutable \textbf{main}.


Pour produire \textbf{main}, le compilateur a donc besoin du fichier \textbf{main.o}. Dans notre cas, les fichiers \textbf{c.h} et \textbf{d.h} sont déclarés en \textit{header}, ce qui implique que les fichiers \textbf{c.o} et \textbf{d.o} sont aussi demandés. De plus, les fichiers \textbf{a.h} et \textbf{b.h} sont demandés par \textbf{c.h}, et \textbf{a.h} est demandé par \textbf{d.h}. Pour compiler le fichier \textbf{main.c}, il faut donc avoir accès aux fichiers \textbf{main.o}, \textbf{a.o}, \textbf{b.o}, \textbf{c.o} et \textbf{d.o}.
On ajoute donc les lignes suivantes au fichier \textbf{Makefile} :
\begin{verbatim}
main: main.o a.o b.o c.o d.o
    gcc -o main main.o a.o b.o c.o d.o
\end{verbatim}

Pour le reste, on construit alors un graphe de dépendance (voir figure \ref{fig:dependance_test}), où $\mathbf{x}\rightarrow \mathbf{y}$ signifie que le fichier \textbf{y} a besoin du fichier \textbf{x} pour être compilé.


\begin{figure}[h]
\centering
% https://tikzcd.yichuanshen.de/#N4Igdg9gJgpgziAXAbVABwnAlgFyxMJZABgBpiBdUkANwEMAbAVxiRAB12cYAPHf4FAB0AYwC+IMaXSZc+QijIBGKrUYs2nbnwHCAFhKkzseAkTIAmVfWatEHLr345gdUYekgMJ+edIBma3U7B21nVyEDSU9vOTNFUgAWINtNRx0XEXdo4ziFElIAVhSNey0nASyooy9ZU3yyADYSkPKM4AAjbJrY+r8Adha0sIEu6pi63xQLUhVqG1LQipdhCA9cvumAobL08Lc1nNqfeOQZ4vng4eXgLMOeydOZwcvU3ZGXLvuJk-zEpJ2S3aAFs6FgwOtjnkiP8rK9Fm1wqDwUJ7qoYFAAObwIigABmACcIMCkGQQDgIEgABw1QnEpBKagU6m0okkxAzcmUxAATlZ9MQ-iZ3L5njp7P+XIZxH57MKwulsqQjQViCUSiViH6qvVmqFUrVZIY4JCcAgxqgR3FSH1zMQVOoHRgYEtiBlYrZ1J1Fk1PO9mvV-o9AqUZLtSh9wfZSlt3Ij1D0MDorrATAYDE18oNMcdztd7vxnrVOv1TpdpLEFDEQA
\begin{tikzcd}
\textbf{d.c} \arrow[rrd]                          &  &                            &  &                            \\
\textbf{d.h} \arrow[rr] \arrow[rrrrd]             &  & \textbf{d.o} \arrow[rrddd] &  &                            \\
\textbf{a.c} \arrow[rrd]                          &  &                            &  & \textbf{main.o} \arrow[dd] \\
\textbf{a.h} \arrow[rr] \arrow[rrdd] \arrow[rruu] &  & \textbf{a.o} \arrow[rrd]   &  &                            \\
\textbf{c.c} \arrow[rrd]                          &  &                            &  & \textbf{main}              \\
\textbf{c.h} \arrow[rr] \arrow[rrrruuu]           &  & \textbf{c.o} \arrow[rru]   &  &                            \\
\textbf{b.c} \arrow[rrd]                          &  &                            &  &                            \\
\textbf{b.h} \arrow[rr]                           &  & \textbf{b.o} \arrow[rruuu] &  &                           
\end{tikzcd}
\caption{Relations de dépendance entre les fichiers du dossier \textbf{test}}
\label{fig:dependance_test}
\end{figure}

Nous pouvons alors en déduire le fichier \textbf{Makefile} (figure \ref{code:makefile_test}).



\begin{figure}[h]
\lstinputlisting[language=c]{ testproj/Makefile }
\caption{Code source de \textbf{Makefile} du projet de test}
\label{code:makefile_test}
\end{figure}


\end{question}


\newpage


\begin{question} %% Question 2

Nous créons un module \textbf{regles.c}, où l'on définit une structure \texttt{regle}. Une \texttt{regle} contient un pointeur vers une chaîne \texttt{nom}, un pointeur vers un tableau \texttt{prerequis} qui représente l'ensemble des fichiers nécessaires pour compiler [\texttt{nom}]. Il y a aussi \texttt{lenPrerequis} la taille de ce tableau que nous stockons pour plus de simplicité dans le code. La liste des commandes à effectuer est stockée dans la liste (nous définissons les listes chaînées dans le module \textbf{listeRegles}) des \texttt{commandes}. Enfin, nous avons choisi d'implémenter l'extension qui remplace la date de dernière modification du fichier par un hash. Les attributs \texttt{lastModified} (temps) et \texttt{hashModified} (booléen) sont donc utilisés, et leur fonctionnement est détaillé en question 10.


Cette structure est munie des fonctions permettant la création de règle (\texttt{createRegle}) et la suppression (\texttt{freeRegle}). Les autres fonctions permettent la gestion des dernières modifications et des hashs, et sont détaillées en question 10.

\end{question}

\begin{question} %% Question 3

Nous définissons un module \textbf{listeRegles.c} qui permet de gérer les ensembles de règles. Comme le code nécessite de parcourir l'ensemble , nous décidons d'implémenter ces ensembles à l'aide de listes simplement chaînées.
La structure \texttt{listeRegles} est donc le pointeur \texttt{NULL}, ou un couple (pointeur vers une \texttt{regle}, pointeur vers une \texttt{listeRegles}).

Les fonctions \texttt{createListeRegle} et \texttt{freeListeRegle} permettent la création et la suppression d'une \texttt{listeRegles}.

La fonction \texttt{addRegle} permet d'ajouter une \texttt{regle} à une \texttt{listeRegles}, via un ajout à la tête.

La fonction \texttt{rechercheRegle} recherche une \texttt{regle} par son nom dans une \texttt{listeRegles}, et la renvoie si elle existe.

La fonction \texttt{iterRegles} permet d'appliquer une fonction à tous les éléments d'une \texttt{listeRegles}. 

La fonction \texttt{revListRegle} renvoie la liste renversée de celle donnée en argument.

Enfin, les fonctions \texttt{getLatestModify} et \texttt{childModified} seront détaillées en question 10.



\end{question}

\begin{question} %% Question 4

Le fichier \textbf{Makefile} du projet est le suivant :

\begin{figure}[h]
\lstinputlisting{Makefile}
\caption{Code source de \textbf{Makefile} de \texttt{myMake}}
\end{figure}
\end{question}

\begin{question} %% Question 5

Dans le fichier \texttt{main.c}, nous définissons une fonction \texttt{makefile2list}, qui prend en argument un pointeur vers un fichier \textbf{makefile} valide, et renvoie un pointeur vers une liste de règles représentant les règles définies dans le fichier.

Son fonctionnement est le suivant :

\begin{enumerate}
\item une liste vide de règles est créée
\item la ligne courante du fichier est lue, elle est du type \texttt{nom : <listePrerequis>}. Une nouvelle règle vide est crée, où la fonction ajoute toutes les lignes suivantes non-vides, c'est-à-dire des lignes de type \texttt{<commande>}
\item la première ligne vide rencontrée (constituée du seul caractère $\mathtt{\backslash n}$) lue, ou la fin du fichier, déclenche l'ajout de la règle courante dans la liste.
\item Retour à l'étape 2
\end{enumerate}


La lecture s'effectue grâce à la fonction \texttt{getline}. Ainsi, la commande \begin{center}
\texttt{tailleLigne = getline(\&ligne\_buffer, \&tailleLigne\_buffer, makefile)}
\end{center}
écrit la ligne courante du fichier \texttt{makefile} dans la chaîne \texttt{ligne\_buffer}, stocke sa longueur dans \texttt{taille\_ligne} (en comptant le retour à la ligne). La variable \texttt{tailleLigne\_buffer} ne sera pas utilisée ici.




\end{question}

\begin{question} %% Question 6

\end{question}

\begin{question} %% Question 7

\end{question}




% A rajouter à terme :
% Pointeurs de fonctions en C

\begin{thebibliography}{99}
  \bibitem{getline}
  \textit{Parcourir un fichier texte ligne par ligne en C},
  \texttt{code-examples.net/fr/q/8c794b},
  08/10/22.

  \bibitem{strtok}
  \textit{C library function - strtok()},
  \texttt{tutorialspoint.com/c\_standard\_library/c\_function\_strtok.htm},
  08/10/22.
  
  \bibitem{hash}
  \textit{Hash Functions},
  \texttt{cse.yorku.ca/$\sim$oz/hash.html},
  08/10/22.


\end{thebibliography}

\end{document}